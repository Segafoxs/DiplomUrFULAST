{% extends 'hello/example.html' %}

{% block title %}
    Cоздание наряда-допуск

{% endblock %}

{% block content %}

<div>
    <h3>Оформление наряда-допуска</h3>
</div>

<br>
<form id="postDirectorForm">
    {% csrf_token %}
    <div class="row">
        <div class="col-md-4 mb-4 pb-2">
            <input type="text" name="search_director" id="searchDirectorInput" class="form-control form-control-lg" placeholder="ФИО">
            <label class="form-label" for="searchDirectorInput">Наряд-допуск выдал</label>
        </div>
        <div class="col-md-4 mb-4 pb-2">
            <button type="button" class="btn btn-light" onclick="submitPost('postDirectorForm', 'postDirector/')">Отправить</button>
        </div>
    </div>
</form>

<form id="postManagerForm">
    {% csrf_token %}
    <div class="row">
        <div class="col-md-4 mb-4 pb-2">
            <input type="text" name="search_manager" id="searchManagerInput" class="form-control form-control-lg" placeholder="ФИО руководителя">
            <label class="form-label" for="searchManagerInput">Руководитель работ</label>
        </div>
        <div class="col-md-4 mb-4 pb-2">
            <button type="button" class="btn btn-light" onclick="submitPost('postManagerForm', '/workPermit/postManager/')">Отправить</button>
        </div>
    </div>
</form>

<form id="postExecutorForm">
    {% csrf_token %}
    <div class="row">
        <div class="col-md-4 mb-4 pb-2">
            <input type="text" name="search_executor" id="searchExecutorInput" class="form-control form-control-lg" placeholder="ФИО исполнителя">
            <label class="form-label" for="searchExecutorInput">Исполнитель работ</label>
        </div>
        <div class="col-md-4 mb-4 pb-2">
            <button type="button" class="btn btn-light" onclick="submitPost('postExecutorForm', '/workPermit/postExecutor/')">Отправить</button>
        </div>
    </div>
</form>

<form id="postShiftManagerForm">
    {% csrf_token %}
    <div class="row">
        <div class="col-md-4 mb-4 pb-2">
            <input type="text" name="search_shiftManager" id="searchShiftManagerInput" class="form-control form-control-lg" placeholder="ФИО начальника смены">
            <label class="form-label" for="searchShiftManagerInput">Начальник смены</label>
        </div>
        <div class="col-md-4 mb-4 pb-2">
            <button type="button" class="btn btn-light" onclick="submitPost('postShiftManagerForm', '/workPermit/postShiftManager/')">Отправить</button>
        </div>
    </div>
</form>

<form id="postStateEngineerForm">
    {% csrf_token %}
    <div class="row">
        <div class="col-md-4 mb-4 pb-2">
            <input type="text" name="search_state_engineer" id="searchStateEngineerInput" class="form-control form-control-lg" placeholder="ФИО дежурного инженера">
            <label class="form-label" for="searchStateEngineerInput">Дежурный инженер станции</label>
        </div>
        <div class="col-md-4 mb-4 pb-2">
            <button type="button" class="btn btn-light" onclick="submitPost('postStateEngineerForm', '/workPermit/postStateEngineer/')">Отправить</button>
        </div>
    </div>
</form>


<!--        <div class="row">-->
<!--                    <div class="col-md-2 mb-4 pb-2">-->

<!--                      <div data-mdb-input-init class="form-outline">-->
<!--                        <input type="text" id="countInp" size="1" maxlength="1"/>-->
<!--                        <label class="form-label" for="form3Examplev2">Количество членов бригады</label>-->
<!--                        <form id="myForm">-->


<!--                        <input type="submit" id="btnSub"/>-->
<!--                        </form>-->
<!--                      </div>-->
<!--                    </div>-->
<!--                    <div class="col-md-8 mb-4 pb-2">-->

<!--                      <div class="col-md-9 pe-1">-->
<!--                          <textarea name="member" class="form-control" rows="3"></textarea>-->
<!--                          Должность, ФИО, разряд членов бригады-->
<!--                      </div>-->
<!--                    </div>-->
<!--            </div>-->


  <form method="post" id="workPermitForm">
    {% csrf_token %}
    
    <div class="row align-items-center py-3">
        <div class="col-md-4 mb-4 pb-2">
            {{ form_department }}
        </div>
    </div>

    <div class="row align-items-center py-3">
        <div class="col-md-4 mb-4 pb-2">
            <label for="countMemberInput" class="form-label">Количество членов бригады</label>
            <input type="number" name="countMember" id="countMemberInput" class="form-control form-control-lg" placeholder="Введите количество" min="1" oninput="generateMemberFields(this.value)" />
        </div>
    </div>

    <div class="row" id="memberFieldsContainer">
    </div>

    <div class="row align-items-center py-3">
        <div class="col-md-7 pe-5">
            <label for="workDescription" class="form-label">Название работы</label>
            <textarea class="form-control" name="work" id="workDescription" rows="3" placeholder="Название работы, район, оборудование, отметка"></textarea>
        </div>
    </div>

    <div class="row align-items-center py-3">
        <div class="col-md-7 pe-5">
            <fieldset>
              <legend>Для обеспечения безопасных условий необходимо</legend>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="instagram" name="source" value="Оградить рабочее место сигнальной лентой">
                <font size="4"><label class="form-check-label" for="instagram">Оградить рабочее место сигнальной лентой</label></font>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="facebook" name="source" value="Работать при достаточном освещении">
                <font size="4"><label class="form-check-label" for="facebook">Работать при достаточном освещении</label></font>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="search-engine" name="source" value="Соблюдать осторожность вблизи с работающим оборудованием">
                <font size="4"><label class="form-check-label" for="search-engine">Соблюдать осторожность вблизи с работающим оборудованием</label></font>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="word-of-mouth" name="source" value="Соблюдать требования ОТ и ПБ при работе с эл. инструментом">
                <font size="4"><label class="form-check-label" for="word-of-mouth">Соблюдать требования ОТ и ПБ при работе с эл. инструментом</label></font>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="event" name="source" value="Работать в исправной спецодежде.">
                <font size="4"><label class="form-check-label" for="event">Работать в исправной спецодежде.</label></font>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="billboard1" name="source" value="По окончании работ убрать рабочее место.">
                <font size="4"><label class="form-check-label" for="billboard1">По окончании работ убрать рабочее место.</label></font>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="billboard2" name="source" value="Применять СИЗ.">
                <font size="4"><label class="form-check-label" for="billboard2">Применять СИЗ.</label></font>
              </div>
              <div class="form-check"><font size="4"><strong>Работа с краном</strong></font></div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="press" name="source" value="Соблюдать требования при работе с ПС.">
                <font size="4"><label class="form-check-label" for="press">Соблюдать требования при работе с ПС.</label></font>
              </div>
                <div class="form-check">
                    <font size="4"><strong>Огневые работы</strong></font>
                </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="billboard3" name="source" value="Огневые работы производить по отдельному наряду-допуску.">
                <font size="4"><label class="form-check-label" for="billboard3">Огневые работы производить по отдельному наряду-допуску.</label></font>
              </div>
            </fieldset>

        </div>
    </div>

    <div class="row">
        <div class="col-md-3 mb-4 pb-2">
            <label for="dateStart" class="form-label">Дата начала работы</label>
            <input type="date" name="dateStart" id="dateStart" class="form-control form-control-lg" />
        </div>
        <div class="col-md-3 mb-4 pb-2">
            <label for="timeStart" class="form-label">Время начала работы</label>
            <input type="time" name="timeStart" id="timeStart" class="form-control form-control-lg" />
        </div>
        <div class="col-md-3 mb-4 pb-2">
            <label for="dateEnd" class="form-label">Дата окончания</label>
            <input type="date" name="dateEnd" id="dateEnd" class="form-control form-control-lg" />
        </div>
        <div class="col-md-3 mb-4 pb-2">
            <label for="timeEnd" class="form-label">Время окончания</label>
            <input type="time" name="timeEnd" id="timeEnd" class="form-control form-control-lg" />
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-4 pb-2">
            <label for="conditions" class="form-label">Особые условия</label>
            <input type="text" name="conditions" id="conditions" class="form-control form-control-lg" />
        </div>
    </div>

    <div class="row">
        <div class="col-md-3 mb-4 pb-2">
            <label for="dateDelivery" class="form-label">Дата выдачи наряда</label>
            <input type="date" name="dateDelivery" id="dateDelivery" class="form-control form-control-lg" />
        </div>
        <div class="col-md-3 mb-4 pb-2">
            <label for="timeDelivery" class="form-label">Время выдачи наряда</label>
            <input type="time" name="timeDelivery" id="timeDelivery" class="form-control form-control-lg" />
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <button type="button" class="btn btn-primary" onclick="submitPost('workPermitForm', '/workPermit/resultWorkPermit/')">Создать</button>
        </div>
    </div>
</form>


<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="resultModalLabel">Результат</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
              <!-- Здесь будет отображён результат -->
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
          </div>
      </div>
  </div>
</div>
  
<script>
async function submitPost(formId, url) {
    const form = document.getElementById(formId);
    const formData = new FormData(form);
    const csrfToken = form.querySelector("[name=csrfmiddlewaretoken]").value;

    for (const [key, value] of formData.entries()) {
        if (!value.trim()) {
            const modalBody = document.querySelector("#resultModal .modal-body");
            modalBody.innerHTML = `<p class="text-danger">Поле "${key}" не может быть пустым.</p>`;
            const resultModal = new bootstrap.Modal(document.getElementById("resultModal"));
            resultModal.show();
            return;
        }
    }

    try {
        const response = await fetch(url, {
            method: "POST",
            headers: {
                "X-CSRFToken": csrfToken
            },
            body: formData
        });

        const result = await response.json();

        const modalBody = document.querySelector("#resultModal .modal-body");
        if (response.ok) {
            modalBody.innerHTML = `<p>${result.success}</p>`;
        } else {
            modalBody.innerHTML = `<p class="text-danger">${result.error}</p>`;
        }

        const resultModal = new bootstrap.Modal(document.getElementById("resultModal"));
        resultModal.show();
    } catch (error) {
        console.error("Ошибка запроса:", error);
    }
}
function generateMemberFields(count) {
    const container = document.getElementById("memberFieldsContainer");
    container.innerHTML = "";
    for (let i = 0; i < count; i++) {
        const row = document.createElement("div");
        row.className = "col-md-4 mb-4 pb-2";
        row.innerHTML = `
            <div data-mdb-input-init class="form-outline">
                <input type="text" name="members[${i}]" id="member_${i}" class="form-control form-control-lg" placeholder="ФИО члена бригады" required />
                <label class="form-label" for="member_${i}">Член бригады ${i + 1}</label>
            </div>
        `;
        container.appendChild(row);
    }
}
</script>




{% endblock %}